<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Encurtador com Registro e Rastreamento</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
      background: #f2f2f2;
    }
    input, button, select {
      padding: 10px;
      margin: 5px;
      width: 280px;
    }
    button {
      cursor: pointer;
    }
    .visitantes, .estatisticas {
      margin-top: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.1);
      text-align: left;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 6px;
      border-bottom: 1px solid #ddd;
    }
    .exportar {
      margin-top: 15px;
      text-align: center;
    }
  </style>
  <!-- Bibliotecas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

  <header>
    <h1>üîó Encurtador com Registro e Rastreamento</h1>
  </header>

  <main id="mainContent">
    <p>Digite um link para encurtar:</p>
    <input type="text" id="originalUrl" placeholder="https://exemplo.com"><br>
    <input type="text" id="origem" placeholder="Origem (WhatsApp, Instagram...) - Opcional"><br>
    <button onclick="encurtar()">Encurtar</button>
    <p id="shortLink"></p>
  </main>

  <div id="formVisita" style="display:none;">
    <h2>Registrar Visita</h2>
    <input type="text" id="nome" placeholder="Seu nome"><br>
    <input type="text" id="celular" placeholder="Seu celular"><br>
    <button onclick="salvarVisita()">Confirmar Visita</button>
  </div>

  <div class="estatisticas">
    <h2>üìä Estat√≠sticas</h2>
    <p><strong>Total de Links:</strong> <span id="totalLinks">0</span></p>
    <p><strong>Total de Visitas:</strong> <span id="totalVisitas">0</span></p>

    <label>Filtrar por per√≠odo:</label>
    <select id="filtroPeriodo" onchange="atualizarEstatisticas()">
      <option value="todos">Todos</option>
      <option value="dia">Hoje</option>
      <option value="semana">√öltimos 7 dias</option>
      <option value="mes">Este m√™s</option>
      <option value="ano">Este ano</option>
    </select>

    <h3>Visitas por Origem:</h3>
    <ul id="origensList"></ul>
    <h3>Ranking de Nomes:</h3>
    <ul id="rankingList"></ul>

    <button style="margin-top:10px;background:#ff4444;color:white;" onclick="limparEstatisticas()">üóëÔ∏è Limpar Estat√≠sticas</button>
  </div>

  <div class="visitantes">
    <h2>üë• Visitantes Registrados</h2>
    <ul id="visitorList"></ul>

    <div class="exportar">
      <button onclick="exportarExcel()">üìë Exportar Excel</button>
      <button onclick="exportarPDF()">üìÑ Exportar PDF</button>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Meu Site. Todos os direitos reservados.</p>
  </footer>

  <script>
    // Coloque aqui sua URL do Apps Script
    const GOOGLE_SCRIPT_URL = "COLE_SUA_URL_AQUI";

    // Fun√ß√£o para encurtar link
    function encurtar() {
      const originalUrl = document.getElementById('originalUrl').value;
      const origem = document.getElementById('origem').value || "N√£o informada";
      if (!originalUrl) return alert("Digite um link v√°lido!");

      const codigo = Math.random().toString(36).substring(2, 8);
      const shortUrl = `${window.location.origin}${window.location.pathname}?r=${codigo}`;

      localStorage.setItem("link_" + codigo, JSON.stringify({url: originalUrl, origem}));

      atualizarEstatisticas();

      document.getElementById('shortLink').innerHTML =
        `Seu link: <a href="${shortUrl}">${shortUrl}</a>`;
    }

    // Detectar se acessou com link encurtado
    window.onload = function () {
      const params = new URLSearchParams(window.location.search);
      const codigo = params.get("r");

      if (codigo) {
        const dados = JSON.parse(localStorage.getItem("link_" + codigo));
        if (dados) {
          document.getElementById("mainContent").style.display = "none";
          document.getElementById("formVisita").style.display = "block";
          localStorage.setItem("visitandoCodigo", codigo);
        }
      }
      carregarVisitas();
      atualizarEstatisticas();
    };

    // Salvar visita
    function salvarVisita() {
      const nome = document.getElementById("nome").value;
      const celular = document.getElementById("celular").value;
      const codigo = localStorage.getItem("visitandoCodigo");
      const dados = JSON.parse(localStorage.getItem("link_" + codigo));

      if (!nome || !celular) return alert("Preencha todos os campos!");

      const visitas = JSON.parse(localStorage.getItem("visitas") || "[]");

      const novaVisita = {
        nome,
        celular,
        link: dados.url,
        origem: dados.origem,
        data: new Date().toISOString()
      };

      visitas.push(novaVisita);
      localStorage.setItem("visitas", JSON.stringify(visitas));
      carregarVisitas();
      atualizarEstatisticas();

      // Envia tamb√©m para o Google Sheets
      if (GOOGLE_SCRIPT_URL !== "COLE_SUA_URL_AQUI") {
        fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(novaVisita),
          headers: {"Content-Type": "application/json"}
        });
      }

      alert("Visita registrada! Redirecionando...");
      window.location.href = dados.url;
    }

    // Filtro de per√≠odo
    function filtrarPorPeriodo(visitas) {
      const filtro = document.getElementById("filtroPeriodo").value;
      const agora = new Date();

      return visitas.filter(v => {
        const data = new Date(v.data);
        if (filtro === "dia") return data.toDateString() === agora.toDateString();
        if (filtro === "semana") return (agora - data) / (1000*60*60*24) <= 7;
        if (filtro === "mes") return data.getMonth() === agora.getMonth() && data.getFullYear() === agora.getFullYear();
        if (filtro === "ano") return data.getFullYear() === agora.getFullYear();
        return true;
      });
    }

    // Carregar lista de visitas
    function carregarVisitas() {
      const visitas = JSON.parse(localStorage.getItem("visitas") || "[]");
      const lista = document.getElementById("visitorList");
      lista.innerHTML = "";

      filtrarPorPeriodo(visitas).forEach(v => {
        const li = document.createElement("li");
        li.textContent = `${v.nome} (${v.celular}) visitou ${v.link} via ${v.origem} em ${new Date(v.data).toLocaleString()}`;
        lista.appendChild(li);
      });
    }

    // Atualizar estat√≠sticas
    function atualizarEstatisticas() {
      let totalLinks = 0;
      for (let key in localStorage) {
        if (key.startsWith("link_")) totalLinks++;
      }
      document.getElementById("totalLinks").textContent = totalLinks;

      const visitas = JSON.parse(localStorage.getItem("visitas") || "[]");
      const filtradas = filtrarPorPeriodo(visitas);
      document.getElementById("totalVisitas").textContent = filtradas.length;

      // Estat√≠sticas por origem
      const origens = {};
      filtradas.forEach(v => {
        origens[v.origem] = (origens[v.origem] || 0) + 1;
      });

      const origensList = document.getElementById("origensList");
      origensList.innerHTML = "";
      for (let origem in origens) {
        const li = document.createElement("li");
        li.textContent = `${origem}: ${origens[origem]} visitas`;
        origensList.appendChild(li);
      }

      // Ranking de nomes
      const ranking = {};
      filtradas.forEach(v => {
        ranking[v.nome] = (ranking[v.nome] || 0) + 1;
      });

      const rankingList = document.getElementById("rankingList");
      rankingList.innerHTML = "";
      Object.entries(ranking)
        .sort((a, b) => b[1] - a[1])
        .forEach(([nome, qtd]) => {
          const li = document.createElement("li");
          li.textContent = `${nome}: ${qtd} acessos`;
          rankingList.appendChild(li);
        });
    }

    // Limpar estat√≠sticas
    function limparEstatisticas() {
      if (confirm("Tem certeza que deseja apagar todos os registros?")) {
        localStorage.removeItem("visitas");
        carregarVisitas();
        atualizarEstatisticas();
      }
    }

    // Exportar Excel
    function exportarExcel() {
      const visitas = filtrarPorPeriodo(JSON.parse(localStorage.getItem("visitas") || "[]"));
      if (visitas.length === 0) return alert("Nenhuma visita registrada!");

      const dados = visitas.map(v => ({
        Nome: v.nome,
        Celular: v.celular,
        Link: v.link,
        Origem: v.origem,
        Data: new Date(v.data).toLocaleString()
      }));

      const ws = XLSX.utils.json_to_sheet(dados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Visitas");

      XLSX.writeFile(wb, "visitas.xlsx");
    }

    // Exportar PDF (com tabela)
    async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const visitas = filtrarPorPeriodo(JSON.parse(localStorage.getItem("visitas") || "[]"));
      if (visitas.length === 0) return alert("Nenhuma visita registrada!");

      const colunas = ["Nome", "Celular", "Link", "Origem", "Data"];
      const linhas = visitas.map(v => [v.nome, v.celular, v.link, v.origem, new Date(v.data).toLocaleString()]);

      doc.text("Relat√≥rio de Visitas", 14, 15);
      doc.autoTable({
        head: [colunas],
        body: linhas,
        startY: 20,
        styles: { fontSize: 9 }
      });

      doc.save("visitas.pdf");
    }
  </script>
</body>
</html>
